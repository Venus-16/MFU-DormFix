<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>navbar</title>
    <link rel="stylesheet" href="/public/css/staff/nav_bar_staff.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="navbar d-flex justify-content-between align-items-center">
        <div class="navbar-left d-flex align-items-center">
            <div class="toggle-btn" onclick="toggleSidebar()" style="cursor: pointer;">
                <i class="fa-solid fa-bars fa-xl"></i>
            </div>
            <img src="/public/img/MFU.png" class="logo" alt="MFU Logo" />
            <span class="title d-flex flex-row">
                <span class="mfu fw-bold text-danger">MFU</span>
                <span class="dormfix text-warning">DormFix</span>
            </span>
        </div>

        <div class="navbar-right d-flex align-items-center" style="position: relative;">
            <!-- Notification Bell -->
            <div style="position:relative; display:inline-block;">
                <button id="notificationBtn" class="btn position-relative me-3" style="z-index:1060;">
                    <i class="fa-solid fa-bell"></i>
                    <span id="notificationCount"
                        class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none"></span>
                </button>
                <div id="notificationDropdown" class="dropdown-menu"
                    style="min-width:350px; max-height:400px; overflow-y:auto; position:absolute; right:0; top:40px; z-index:1050; display:none;">
                    <div class="p-3 border-bottom fw-bold d-flex align-items-center justify-content-between">
                        <span>Notifications</span>
                        <button id="markAllAsReadBtn" class="btn btn-outline-success btn-sm ms-3"
                            style="font-size:0.9rem;">Mark as read</button>
                    </div>
                    <div class="d-flex gap-2 px-3 py-2 border-bottom">
                        <button id="allNotiBtn" class="btn btn-outline-primary btn-sm active"
                            style="font-size: 0.9rem;">All</button>
                        <button id="unreadNotiBtn" class="btn btn-outline-secondary btn-sm"
                            style="font-size: 0.9rem;">Unread</button>
                    </div>
                    <ul class="list-unstyled mb-0" id="notificationList">
                        <li class="px-3 py-2 text-muted small">No new notifications</li>
                    </ul>
                </div>
            </div>
            <a href="/staff/profile" class="d-flex align-items-center text-decoration-none text-dark">
                <div class="user-info text-end">
                    <div class="name fw-bold" id="nav-name">Loading...</div>
                    <div class="role text-muted small">Dormitory staff</div>
                </div>
                <i class="fa-solid fa-user-circle fa-2x ms-2" style="color:#8b8b8b;" id="nav-profile-pic"></i>
            </a>
        </div>
    </div>

    <div class="tabs">
        <p class="menu px-3">MENU</p>
        <a href="/staff/dashboard" class="tab-item">
            <i class="fa-solid fa-chart-line"></i>
            <span>Dashboard</span>
        </a>
        <a href="/staff/reapir" class="tab-item">
            <i class="fa-solid fa-screwdriver-wrench"></i>
            <span>Repair Report</span>
        </a>
        <a href="/staff/list" class="tab-item">
            <i class="fa-solid fa-clipboard-list"></i>
            <span>List of Student</span>
        </a>
        <a href="/staff/sch" class="tab-item">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Repair Schedule</span>
        </a>
        <a href="/staff/history" class="tab-item">
            <i class="fa-solid fa-clock-rotate-left"></i>
            <span>History</span>
        </a>
        <div class="logout-wrapper">
            <button type="button" class="logout" onclick="showLogoutModal()">
                <i class="fa-solid fa-right-from-bracket"></i> Log out
            </button>
        </div>
    </div>

    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered custom-modal">
            <div class="modal-content text-center p-4">
                <h5 class="fw-bold mb-2 fs-2 py-4">Do you want to logout?</h5>
                <div class="d-flex justify-content-center gap-5">
                    <button type="button" class="btn btn-primary btn-lg fw-bold" onclick="handleLogout()">
                        Yes
                    </button>
                    <button type="button" class="btn btn-danger btn-lg fw-bold" data-bs-dismiss="modal">
                        No
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allNotifications = [];
        let filterType = "all"; // "all" or "unread"

        document.addEventListener('DOMContentLoaded', function () {
            const currentPath = window.location.pathname;
            const tabItems = document.querySelectorAll('.tab-item');

            tabItems.forEach(item => {
                if (item.getAttribute('href') === currentPath) {
                    item.classList.add('active');
                }
            });

            fetch('/staff/nevbar_name')
                .then(res => {
                    if (!res.ok) throw new Error('Cannot fetch name');
                    return res.json();
                })
                .then(data => {
                    document.getElementById('nav-name').textContent = data.name;
                })
                .catch(err => {
                    document.getElementById('nav-name').textContent = 'Staff';
                });

            fetchNotifications();
        });

        function toggleSidebar() {
            const sidebar = document.querySelector(".tabs");
            const body = document.body;
            sidebar.classList.toggle("collapsed");
            body.classList.toggle("sidebar-collapsed");
        }

        function handleLogout() {
            fetch('/logout', {
                method: 'POST',
                credentials: 'include'
            })
                .then(() => {
                    window.location.replace("/login");
                });
        }

        function showLogoutModal() {
            const modal = new bootstrap.Modal(
                document.getElementById("logoutModal")
            );
            modal.show();
        }

        // -------------------------------
        // Notification Logic
        // -------------------------------
        const notificationBtn = document.getElementById("notificationBtn");
        const notificationDropdown = document.getElementById("notificationDropdown");
        const notificationCount = document.getElementById("notificationCount");
        const notificationList = document.getElementById("notificationList");
        const markAllAsReadBtn = document.getElementById("markAllAsReadBtn");
        const allNotiBtn = document.getElementById("allNotiBtn");
        const unreadNotiBtn = document.getElementById("unreadNotiBtn");

        notificationBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            notificationDropdown.style.display =
                notificationDropdown.style.display === "block" ? "none" : "block";
            renderNotifications();
        });

        document.addEventListener("click", (e) => {
            if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                notificationDropdown.style.display = "none";
            }
        });

        function formatDateDMYHM(dateStr) {
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            let hour = d.getHours();
            let min = String(d.getMinutes()).padStart(2, '0');
            let ampm = "AM";
            if (hour >= 12) {
                ampm = "PM";
                if (hour > 12) hour -= 12;
            }
            if (hour === 0) hour = 12;
            return `${day}/${month}/${year} ${hour}:${min} ${ampm}`;
        }

        function renderNotifications() {
            notificationList.innerHTML = "";
            let filtered = [];
            if (filterType === "unread") {
                filtered = allNotifications.filter(n => n.is_read === 0);
            } else {
                filtered = allNotifications;
            }

            if (filtered.length === 0) {
                notificationList.innerHTML = `<li class="px-3 py-2 text-muted small">No notifications</li>`;
                return;
            }

            // เรียงลำดับใหม่โดยล่าสุดอยู่บน
            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            filtered.forEach(noti => {
                const li = document.createElement("li");
                li.className =
                    "px-3 py-2 small border-bottom cursor-pointer " +
                    (noti.is_read === 0
                        ? "bg-warning-subtle text-dark"
                        : "bg-white text-muted");

                li.innerHTML = `
                    <div class="fw-bold">${noti.title || ""}</div>
                    <div class="fw-normal">${noti.message || ""}</div>
                    <div class="small text-secondary">${formatDateDMYHM(noti.created_at)}</div>
                `;

                li.addEventListener("click", async () => {
                    await fetch("/staff/notifications/read", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ notification_id: noti.notification_id })
                    });
                    noti.is_read = 1;
                    renderNotifications();
                    updateNotificationCount();
                    if (noti.link) {
                        window.location.href = noti.link;
                    }
                });

                notificationList.appendChild(li);
            });
        }

        async function fetchNotifications() {
            try {
                const res = await fetch("/staff/notifications");
                if (!res.ok) throw new Error("Failed to fetch");
                const data = await res.json();
                allNotifications = data;
                renderNotifications();
                updateNotificationCount();
            } catch (err) {
                console.error(err);
            }
        }

        function updateNotificationCount() {
            const unread = allNotifications.filter(n => n.is_read === 0).length;
            if (unread > 0) {
                notificationCount.textContent = unread;
                notificationCount.classList.remove("d-none");
            } else {
                notificationCount.classList.add("d-none");
            }
        }

        markAllAsReadBtn.addEventListener("click", async function () {
            try {
                await fetch('/staff/notifications/read-all', {
                    method: 'POST',
                    credentials: 'include'
                });
                await fetchNotifications();
            } catch (e) {
                console.error(e);
            }
        });

        allNotiBtn.addEventListener("click", function () {
            filterType = "all";
            allNotiBtn.classList.add("active");
            unreadNotiBtn.classList.remove("active");
            renderNotifications();
        });

        unreadNotiBtn.addEventListener("click", function () {
            filterType = "unread";
            allNotiBtn.classList.remove("active");
            unreadNotiBtn.classList.add("active");
            renderNotifications();
        });

        // Auto update every 30s
        fetchNotifications();
        setInterval(fetchNotifications, 30000);
    </script>
</body>

</html>