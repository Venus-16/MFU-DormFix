<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon">
    <link rel="stylesheet" href="/public/css/staff/nav_bar_staff.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/public/css/staff/profile_staff.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div id="navbar"></div>
    <!-- Main Layout -->
    <div class="d-flex" style="flex: 1;">
        <!-- Sidebar -->
        <div id="sidebar"></div>
        <div class="container py-5 mt-5" style="margin-left: 160px;">
            <div class="card">
                <div class="left-panel">
                    <div id="imagp">
                        <i class="fas fa-user-circle" style="font-size: 200px;"></i>
                    </div>
                </div>
                <div class="right-panel">
                    <p class="label">Name</p>
                    <p class="value" id="name">Loading...</p>
                    <p class="label">Email</p>
                    <p class="value" id="email">Loading...</p>
                    <p class="label">Phone</p>
                    <p class="value" id="phone">Loading...</p>
                    <p class="label">Dormitory Staff</p>
                    <p class="value" id="dorm">Loading...</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ---- Notification Logic (เหมือนของ navbar) ----
        let allNotifications = [];
        let filterType = "all"; // "all" or "unread"

        function formatDateDMYHM(dateStr) {
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            let hour = d.getHours();
            let min = String(d.getMinutes()).padStart(2, '0');
            let ampm = "AM";
            if (hour >= 12) {
                ampm = "PM";
                if (hour > 12) hour -= 12;
            }
            if (hour === 0) hour = 12;
            return `${day}/${month}/${year} ${hour}:${min} ${ampm}`;
        }

        function renderNotifications() {
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");
            let filtered = [];
            if (filterType === "unread") {
                filtered = allNotifications.filter(n => n.is_read === 0);
            } else {
                filtered = allNotifications;
            }

            notificationList.innerHTML = "";
            if (filtered.length === 0) {
                notificationList.innerHTML = `<li class="px-3 py-2 text-muted small">No notifications</li>`;
                return;
            }

            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            filtered.forEach(noti => {
                const li = document.createElement("li");
                li.className =
                    "px-3 py-2 small border-bottom cursor-pointer " +
                    (noti.is_read === 0
                        ? "bg-warning-subtle text-dark"
                        : "bg-white text-muted");

                li.innerHTML = `
                    <div class="fw-bold">${noti.title || ""}</div>
                    <div class="fw-normal">${noti.message || ""}</div>
                    <div class="small text-secondary">${formatDateDMYHM(noti.created_at)}</div>
                `;

                li.addEventListener("click", async () => {
                    await fetch("/staff/notifications/read", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ notification_id: noti.notification_id })
                    });
                    noti.is_read = 1;
                    renderNotifications();
                    updateNotificationCount();
                    if (noti.link) {
                        window.location.href = noti.link;
                    }
                });

                notificationList.appendChild(li);
            });
        }

        async function fetchNotifications() {
            try {
                const res = await fetch("/staff/notifications");
                if (!res.ok) throw new Error("Failed to fetch");
                const data = await res.json();
                allNotifications = data;
                renderNotifications();
                updateNotificationCount();
            } catch (err) {
                console.error(err);
            }
        }

        function updateNotificationCount() {
            const notificationCount = document.getElementById("notificationCount");
            const unread = allNotifications.filter(n => n.is_read === 0).length;
            if (unread > 0) {
                notificationCount.textContent = unread;
                notificationCount.classList.remove("d-none");
            } else {
                notificationCount.classList.add("d-none");
            }
        }

        function setupNotificationEvents() {
            const notificationBtn = document.getElementById("notificationBtn");
            const notificationDropdown = document.getElementById("notificationDropdown");
            const markAllAsReadBtn = document.getElementById("markAllAsReadBtn");
            const allNotiBtn = document.getElementById("allNotiBtn");
            const unreadNotiBtn = document.getElementById("unreadNotiBtn");

            if (!notificationBtn || !notificationDropdown) return;
            notificationBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                notificationDropdown.style.display =
                    notificationDropdown.style.display === "block" ? "none" : "block";
                renderNotifications();
            });

            document.addEventListener("click", (e) => {
                if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                    notificationDropdown.style.display = "none";
                }
            });

            if (markAllAsReadBtn) {
                markAllAsReadBtn.addEventListener("click", async function () {
                    try {
                        await fetch('/staff/notifications/read-all', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        await fetchNotifications();
                    } catch (e) {
                        console.error(e);
                    }
                });
            }

            if (allNotiBtn && unreadNotiBtn) {
                allNotiBtn.addEventListener("click", function () {
                    filterType = "all";
                    allNotiBtn.classList.add("active");
                    unreadNotiBtn.classList.remove("active");
                    renderNotifications();
                });

                unreadNotiBtn.addEventListener("click", function () {
                    filterType = "unread";
                    allNotiBtn.classList.remove("active");
                    unreadNotiBtn.classList.add("active");
                    renderNotifications();
                });
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            // โหลด Navbar และ Sidebar
            fetch('/staff/nevbar')
                .then(res => res.text())
                .then(data => {
                    const temp = document.createElement('div');
                    temp.innerHTML = data;

                    const navbar = temp.querySelector('.navbar');
                    const tabs = temp.querySelector('.tabs');
                    const logoutModal = temp.querySelector('#logoutModal');

                    if (navbar) document.getElementById('navbar').appendChild(navbar);
                    if (tabs) document.getElementById('sidebar').appendChild(tabs);
                    if (logoutModal) document.body.appendChild(logoutModal);

                    // เติมชื่อ staff ใน navbar
                    fetch('/staff/nevbar_name')
                        .then(res => {
                            if (!res.ok) throw new Error("Failed to fetch name");
                            return res.json();
                        })
                        .then(data => {
                            const navName = document.getElementById('nav-name');
                            if (navName) navName.textContent = data.name;
                        })
                        .catch(() => {
                            const navName = document.getElementById('nav-name');
                            if (navName) navName.textContent = "Staff";
                        });

                    window.toggleSidebar = function () {
                        const sidebar = document.querySelector(".tabs");
                        const body = document.body;
                        sidebar.classList.toggle("collapsed");
                        body.classList.toggle("sidebar-collapsed");
                    };

                    window.showLogoutModal = function () {
                        const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
                        modal.show();
                    };

                    window.handleLogout = function () {
                        fetch('/logout', {
                            method: 'POST',
                            credentials: 'include'
                        })
                            .then(() => {
                                window.location.href = "/logout";
                            });
                    };

                    // Notification bell logic
                    setTimeout(() => {
                        setupNotificationEvents();
                        fetchNotifications();
                        setInterval(fetchNotifications, 30000);
                    }, 100);
                });

            // Load Profile Data
            fetch('/staff/profile_data')
                .then(res => {
                    if (!res.ok) throw new Error("Failed to load profile");
                    return res.json();
                })
                .then(data => {
                    document.getElementById("name").textContent = data.name;
                    document.getElementById("email").textContent = data.email;
                    document.getElementById("phone").textContent = data.phone_number || "Not Available";
                    document.getElementById("dorm").textContent = data.dorm_name || "Unknown Dormitory";
                })
                .catch(err => {
                    console.error(err);
                    alert("Unable to load profile.");
                });
        });
    </script>
</body>

</html>