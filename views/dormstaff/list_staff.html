<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>List of student</title>
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon">
    <link rel="stylesheet" href="/public/css/staff/list_staff.css">
    <link rel="stylesheet" href="/public/css/staff/nav_bar_staff.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="/public/js/staff/list.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div id="navbar"></div>
    <div class="d-flex" style="flex: 1;">
        <div id="sidebar"></div>
        <div class="main-content">
            <div class="container" id="main-content-area">
                <div id="loading-overlay">
                    <div class="loader-content">
                        <div class="loading-icon" style="background-image: url('/public/img/loader-hourglass.svg');">
                        </div>
                        <div class="loading-text">Loading...</div>
                    </div>
                </div>
                <div class="container py-5 mt-5">
                    <h2>List of Students</h2>

                    <div class="fill d-flex align-items-center gap-4 mt-3 flex-wrap" style="max-width: 1100px;">
                        <div class="d-flex flex-column" style="width: 180px;">
                            <label for="dormitory" class="form-label mb-1"
                                style="font-weight: 500; font-size: 0.85rem;">Dormitory</label>
                            <select class="form-select form-select-sm" id="dormitory" name="dormitory">
                                <option value="">All Dormitories</option>
                            </select>
                        </div>
                        <div class="d-flex flex-column" style="width: 220px;">
                            <label for="school" class="form-label mb-1"
                                style="font-weight: 500; font-size: 0.85rem;">School</label>
                            <select class="form-select form-select-sm" id="school" name="school">
                                <option value="">All Schools</option>
                            </select>
                        </div>
                        <div class="d-flex flex-column" style="width: 220px;">
                            <label for="major" class="form-label mb-1"
                                style="font-weight: 500; font-size: 0.85rem;">Major</label>
                            <select class="form-select form-select-sm" id="major" name="major">
                                <option value="">All Majors</option>
                            </select>
                        </div>
                        <div class="d-flex flex-column flex-grow-1" style="min-width: 250px;">
                            <label class="form-label mb-1" style="visibility: hidden;">Search Section</label>
                            <div class="d-flex gap-2 align-items-center">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="search-name-id-btn">
                                    <i class="fa fa-user"></i> Name/ID
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="search-room-btn">
                                    <i class="fa fa-door-closed"></i> Room
                                </button>
                                <div class="input-group input-group-sm shadow-sm rounded"
                                    style="background: #F5F5F5; width:auto;">
                                    <input type="search" class="form-control border-0" id="search"
                                        placeholder="Search..." style="width: 180px;" />
                                    <span class="input-group-text bg-transparent border-0">
                                        <i class="fa-solid fa-magnifying-glass"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive mt-4">
                        <table class="table table-bordered table-striped align-middle text-center custom-table"
                            style="font-size: 0.9rem; background-color: #FFB4AF;">
                            <thead style="background-color: #FF7C7C !important; color: white !important;">
                                <tr>
                                    <th>Student ID</th>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Room</th>
                                    <th>School</th>
                                    <th>Major</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body">
                                <tr>
                                    <td colspan="6">Loading student data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script>
            // Loader functions, fetches from /loading, covers only main-content-area
            function showLoaderContent() {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = 'flex';
                overlay.innerHTML = '';
                document.body.classList.add('loading-active'); // Prevent scroll
                fetch('/loading')
                    .then(res => res.text())
                    .then(html => {
                        overlay.innerHTML = `<div class="loader-content">${html}</div>`;
                        overlay.style.background = '#fffbe9'; // สีเหลืองอ่อนทึบ
                    });
            }

            function hideLoaderContent() {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = 'none';
                overlay.innerHTML = '';
                overlay.style.background = ''; // Reset background
                document.body.classList.remove('loading-active'); // Enable scroll
            }

            // ---- Notification Logic (เหมือนของ navbar) ----
            let allNotifications = [];
            let filterType = "all"; // "all" or "unread"

            function formatDateDMYHM(dateStr) {
                const d = new Date(dateStr);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                let hour = d.getHours();
                let min = String(d.getMinutes()).padStart(2, '0');
                let ampm = "AM";
                if (hour >= 12) {
                    ampm = "PM";
                    if (hour > 12) hour -= 12;
                }
                if (hour === 0) hour = 12;
                return `${day}/${month}/${year} ${hour}:${min} ${ampm}`;
            }

            function renderNotifications() {
                const notificationList = document.getElementById("notificationList");
                const notificationCount = document.getElementById("notificationCount");
                let filtered = [];
                if (filterType === "unread") {
                    filtered = allNotifications.filter(n => n.is_read === 0);
                } else {
                    filtered = allNotifications;
                }

                notificationList.innerHTML = "";
                if (filtered.length === 0) {
                    notificationList.innerHTML = `<li class="px-3 py-2 text-muted small">No notifications</li>`;
                    return;
                }

                filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                filtered.forEach(noti => {
                    const li = document.createElement("li");
                    li.className =
                        "px-3 py-2 small border-bottom cursor-pointer " +
                        (noti.is_read === 0
                            ? "bg-warning-subtle text-dark"
                            : "bg-white text-muted");

                    li.innerHTML = `
                        <div class="fw-bold">${noti.title || ""}</div>
                        <div class="fw-normal">${noti.message || ""}</div>
                        <div class="small text-secondary">${formatDateDMYHM(noti.created_at)}</div>
                    `;

                    li.addEventListener("click", async () => {
                        await fetch("/staff/notifications/read", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ notification_id: noti.notification_id })
                        });
                        noti.is_read = 1;
                        renderNotifications();
                        updateNotificationCount();
                        if (noti.link) {
                            window.location.href = noti.link;
                        }
                    });

                    notificationList.appendChild(li);
                });
            }

            async function fetchNotifications() {
                try {
                    const res = await fetch("/staff/notifications");
                    if (!res.ok) throw new Error("Failed to fetch");
                    const data = await res.json();
                    allNotifications = data;
                    renderNotifications();
                    updateNotificationCount();
                } catch (err) {
                    console.error(err);
                }
            }

            function updateNotificationCount() {
                const notificationCount = document.getElementById("notificationCount");
                const unread = allNotifications.filter(n => n.is_read === 0).length;
                if (unread > 0) {
                    notificationCount.textContent = unread;
                    notificationCount.classList.remove("d-none");
                } else {
                    notificationCount.classList.add("d-none");
                }
            }

            function setupNotificationEvents() {
                const notificationBtn = document.getElementById("notificationBtn");
                const notificationDropdown = document.getElementById("notificationDropdown");
                const markAllAsReadBtn = document.getElementById("markAllAsReadBtn");
                const allNotiBtn = document.getElementById("allNotiBtn");
                const unreadNotiBtn = document.getElementById("unreadNotiBtn");

                if (!notificationBtn || !notificationDropdown) return;
                notificationBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    notificationDropdown.style.display =
                        notificationDropdown.style.display === "block" ? "none" : "block";
                    renderNotifications();
                });

                document.addEventListener("click", (e) => {
                    if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                        notificationDropdown.style.display = "none";
                    }
                });

                if (markAllAsReadBtn) {
                    markAllAsReadBtn.addEventListener("click", async function () {
                        try {
                            await fetch('/staff/notifications/read-all', {
                                method: 'POST',
                                credentials: 'include'
                            });
                            await fetchNotifications();
                        } catch (e) {
                            console.error(e);
                        }
                    });
                }

                if (allNotiBtn && unreadNotiBtn) {
                    allNotiBtn.addEventListener("click", function () {
                        filterType = "all";
                        allNotiBtn.classList.add("active");
                        unreadNotiBtn.classList.remove("active");
                        renderNotifications();
                    });

                    unreadNotiBtn.addEventListener("click", function () {
                        filterType = "unread";
                        allNotiBtn.classList.remove("active");
                        unreadNotiBtn.classList.add("active");
                        renderNotifications();
                    });
                }
            }

            window.addEventListener("DOMContentLoaded", () => {
                // Show loader only on first load
                showLoaderContent();

                // Load all dropdowns in parallel
                const dormSelect = document.getElementById('dormitory');
                const schoolSelect = document.getElementById('school');
                const majorSelect = document.getElementById('major');
                const tableBody = document.getElementById("report-table-body");
                const searchInput = document.getElementById('search');
                const searchNameIdBtn = document.getElementById('search-name-id-btn');
                const searchRoomBtn = document.getElementById('search-room-btn');

                // Set default search mode
                let currentSearchMode = 'nameid';

                function setSearchMode(mode) {
                    currentSearchMode = mode;
                    if (mode === 'nameid') {
                        searchNameIdBtn.classList.add('active');
                        searchRoomBtn.classList.remove('active');
                        searchInput.placeholder = "Search by name or student ID ...";
                    } else {
                        searchRoomBtn.classList.add('active');
                        searchNameIdBtn.classList.remove('active');
                        searchInput.placeholder = "Search by room number ...";
                    }
                    searchInput.value = "";
                    fetchStudents();
                }

                // Fill Dormitory
                const dormPromise = fetch('/api/dormitory').then(res => res.json()).then(dorms => {
                    dormSelect.innerHTML = '<option value="">All Dormitories</option>';
                    dorms.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.dorm_name;
                        opt.textContent = d.dorm_name;
                        dormSelect.appendChild(opt);
                    });
                });

                // Fill Schools
                const schoolPromise = fetch('/api/schools').then(res => res.json()).then(schs => {
                    schoolSelect.innerHTML = '<option value="">All Schools</option>';
                    schs.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.school_id;
                        opt.textContent = s.school_name.trim();
                        schoolSelect.appendChild(opt);
                    });
                });

                // Major: fill when school changes
                function fillMajors(schoolId) {
                    majorSelect.innerHTML = '<option value="">All Majors</option>';
                    if (!schoolId) return;
                    fetch('/api/majors?school_id=' + encodeURIComponent(schoolId)).then(res => res.json()).then(majors => {
                        majors.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.major_id;
                            opt.textContent = m.major_name;
                            majorSelect.appendChild(opt);
                        });
                    });
                }

                // --- Fetch & Display Students ---
                async function fetchStudents() {
                    tableBody.innerHTML = '<tr><td colspan="6">Loading student data...</td></tr>';
                    const params = [];
                    if (dormSelect.value) params.push('dormName=' + encodeURIComponent(dormSelect.value));
                    if (schoolSelect.value) params.push('school_id=' + encodeURIComponent(schoolSelect.value));
                    if (majorSelect.value) params.push('major_id=' + encodeURIComponent(majorSelect.value));
                    if (searchInput.value.trim()) {
                        if (currentSearchMode === 'nameid') {
                            params.push('search=' + encodeURIComponent(searchInput.value.trim()));
                        } else if (currentSearchMode === 'room') {
                            params.push('room=' + encodeURIComponent(searchInput.value.trim()));
                        }
                    }
                    const url = '/staff/liststu' + (params.length ? '?' + params.join('&') : '');

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = '/views/login.html';
                                return;
                            }
                            throw new Error(await response.text());
                        }
                        const students = await response.json();
                        tableBody.innerHTML = '';
                        if (!Array.isArray(students) || students.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="6">No student found.</td></tr>';
                        } else {
                            students.forEach(student => {
                                const row = document.createElement("tr");
                                row.innerHTML = `
                                    <td>${student.student_id || 'N/A'}</td>
                                    <td>${student.email || 'N/A'}</td>
                                    <td>${student.name || 'N/A'}</td>
                                    <td>${student.room_number || 'N/A'}</td>
                                    <td>${student.school_name || 'N/A'}</td>
                                    <td>${student.major_name || 'N/A'}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        }
                    } catch (error) {
                        console.error('Error fetching student data:', error);
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">Failed to load student data. Please try again later.</td></tr>`;
                    }
                }

                dormSelect.addEventListener('change', fetchStudents);
                schoolSelect.addEventListener('change', () => {
                    fillMajors(schoolSelect.value);
                    majorSelect.value = "";
                    fetchStudents();
                });
                majorSelect.addEventListener('change', fetchStudents);
                searchInput.addEventListener('input', fetchStudents);
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') fetchStudents();
                });

                searchNameIdBtn.addEventListener('click', () => setSearchMode('nameid'));
                searchRoomBtn.addEventListener('click', () => setSearchMode('room'));

                Promise.all([dormPromise, schoolPromise]).then(() => {
                    setTimeout(() => {
                        hideLoaderContent();
                        setSearchMode('nameid'); // This also loads students
                    }, 2000);
                });

                // Navbar, sidebar, etc.
                fetch('/staff/nevbar')
                    .then(res => res.text())
                    .then(data => {
                        const temp = document.createElement('div');
                        temp.innerHTML = data;

                        const navbar = temp.querySelector('.navbar');
                        const tabs = temp.querySelector('.tabs');
                        const logoutModal = temp.querySelector('#logoutModal');

                        if (navbar) document.getElementById('navbar').appendChild(navbar);
                        if (tabs) document.getElementById('sidebar').appendChild(tabs);
                        if (logoutModal) document.body.appendChild(logoutModal);

                        fetch('/staff/nevbar_name')
                            .then(res => {
                                if (!res.ok) throw new Error("Failed to fetch name");
                                return res.json();
                            })
                            .then(data => {
                                const navName = document.getElementById('nav-name');
                                if (navName) navName.textContent = data.name;
                            })
                            .catch(() => {
                                const navName = document.getElementById('nav-name');
                                if (navName) navName.textContent = "Staff";
                            });

                        window.toggleSidebar = function () {
                            const sidebar = document.querySelector(".tabs");
                            const body = document.body;
                            sidebar.classList.toggle("collapsed");
                            body.classList.toggle("sidebar-collapsed");
                        };

                        window.showLogoutModal = function () {
                            const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
                            modal.show();
                        };

                        window.handleLogout = function () {
                            fetch('/logout', {
                                method: 'POST',
                                credentials: 'include'
                            })
                                .then(() => {
                                    window.location.href = "/logout";
                                });
                        };
                        const currentPath = window.location.pathname;
                        const tabItems = document.querySelectorAll('.tab-item');
                        tabItems.forEach(item => {
                            const itemHref = item.getAttribute('href');
                            if (itemHref) {
                                const normalizedItemHref = itemHref.endsWith('/') ? itemHref.slice(0, -1) : itemHref;
                                const normalizedCurrentPath = currentPath.endsWith('/') ? currentPath.slice(0, -1) : currentPath;
                                if (normalizedCurrentPath.startsWith(normalizedItemHref)) {
                                    item.classList.add('active');
                                }
                            }
                        });

                        // ----------- Notification Bell Setup for AJAX Navbar --------------
                        setTimeout(() => {
                            setupNotificationEvents();
                            fetchNotifications();
                            setInterval(fetchNotifications, 30000);
                        }, 100);
                        // -------------------------------------------------------------------
                    });
            });
        </script>
</body>

</html>