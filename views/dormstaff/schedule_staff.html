<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Technician Schedule</title>
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/public/css/staff/nav_bar_staff.css">
    <link rel="stylesheet" href="/public/css/staff/sch_staff.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css" />
    <style>
        body.loading {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #main-content-area {
            position: relative;
            min-height: 10vh;
        }

        #main-content-area.no-scroll {
            overflow: hidden;
        }

        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 251, 233, 0.7);
            z-index: 9999;
        }

        #loading-overlay .loader-content {
            padding: 2rem 3rem;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #loading-overlay,
        #loading-overlay * {
            font-family: inherit !important;
            font-weight: inherit !important;
            color: inherit !important;
        }

        #loading-overlay .loader-content .loading-icon {
            width: 64px;
            height: 64px;
            background: url("/public/img/loader-hourglass.svg") no-repeat center/contain;
            margin-bottom: 16px;
        }

        #loading-overlay .loader-content .loading-text {
            font-size: 2.3rem;
            color: #8d6e3a;
            font-family: 'Prompt', 'Kanit', Arial, sans-serif;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body>
    <div id="navbar"></div>
    <div class="d-flex" style="flex: 1;">
        <div id="sidebar"></div>
        <main class="flex-fill" id="main-content-area">
            <div id="loading-overlay"></div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h4 text-white fw-bold" id="repair">Repair Scheduled</h1>
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <input id="monthYearPicker" class="form-control w-auto" style="width: 200px;"
                        placeholder="Select Month/Year" />
                    <select id="locationFilter" class="form-select form-select-sm w-auto">
                        <option value="all">All Dormitories</option>
                    </select>
                    <select id="categoryFilter" class="form-select form-select-sm w-auto">
                        <option value="all">All Types</option>
                    </select>
                </div>
            </div>
            <div id="calendarGrid" class="calendar"></div>
        </main>
    </div>

    <!-- MODAL STYLE LIKE HEAD/TECHNICIAN -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content shadow rounded-4 border-0">
                <div class="modal-header bg-warning text-dark rounded-top-4">
                    <h5 class="modal-title" id="eventModalLabel">
                        <i class="bi bi-tools me-2"></i>Repair Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-light-subtle">
                    <!-- Basic Info -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-uppercase fw-bold text-warning mb-3">
                                <i class="bi bi-info-circle me-2"></i>Basic Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <p><strong>Name:</strong> <span id="modalName"></span></p>
                                    <p><strong>Request Date:</strong> <span id="modalRequestDate"> </span> , <span
                                            id="modalRequestTime"></span></p>
                                    <p><strong>Repair Date:</strong> <span id="modalRepairDate"></span>, <span
                                            id="modalRepairTime"></span></p>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <p><strong>Status:</strong> <span id="modalStatus" class="badge bg-info"></span></p>
                                    <p><strong>Repair Type:</strong> <span id="modalRepairType"
                                            class="badge bg-primary"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Location Info -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-uppercase fw-bold text-warning mb-3">
                                <i class="bi bi-geo-alt me-2"></i>Location
                            </h6>
                            <p><strong>Dormitory:</strong> <span id="modalDormitory"></span></p>
                            <p><strong>Room:</strong> <span id="modalRoom"></span></p>
                        </div>
                    </div>
                    <!-- Repair Info -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-uppercase fw-bold text-warning mb-3">
                                <i class="bi bi-tools me-2"></i>Repair Information
                            </h6>
                            <p><strong>Item:</strong> <span id="modalDurable"></span></p>
                            <p><strong>Damage Description:</strong> <span id="modalDescription"></span></p>
                        </div>
                    </div>
                    <!-- Technician Info -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="text-uppercase fw-bold text-warning mb-3">
                                <i class="bi bi-person-gear me-2"></i>Assignee
                            </h6>
                            <p><strong>Technician:</strong> <span id="modalTech"></span></p>
                            <p><strong>Phone Number:</strong> <span id="phone"></span></p>
                            <p><strong> Assigned By:</strong> <span id="modalHead"></span></p>
                        </div>
                    </div>
                    <!-- Image LAST -->
                    <div class="card mb-3 border-0 shadow-sm">
                        <div class="card-body text-center">
                            <h6 class="text-uppercase fw-bold text-warning mb-3">
                                <i class="bi bi-image me-2"></i>Image
                            </h6>
                            <img id="modalImage" src="" alt="Repair Image"
                                style="max-width: 100%; height: auto; display: block; margin: 0 auto;">
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-white rounded-bottom-4">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END MODAL -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <script>
        let events = [];
        let selectedMonth = new Date().getMonth();
        let selectedYear = new Date().getFullYear();

        // Loader functions
        function showLoaderContent() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            overlay.innerHTML = '';
            document.getElementById('main-content-area').classList.add('no-scroll');
            fetch('/loading')
                .then(res => res.text())
                .then(html => {
                    overlay.innerHTML = `<div class="loader-content">${html}</div>`;
                    overlay.style.background = '#fffbe9';
                });
        }
        function hideLoaderContent() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
            overlay.innerHTML = '';
            document.getElementById('main-content-area').classList.remove('no-scroll');
        }

        async function getStaffDormitoryName() {
            try {
                const res = await fetch('/staff/profile_data');
                if (!res.ok) throw new Error("Failed to get staff profile");
                const data = await res.json();
                return data.dorm_name || null;
            } catch (e) {
                console.error("Error fetching staff dormitory:", e);
                return null;
            }
        }
        function saveDormToLocalStorage(value) {
            try { localStorage.setItem('lastDormitory', value); } catch (_) { }
        }
        function getDormFromLocalStorage() {
            try { return localStorage.getItem('lastDormitory'); } catch (_) { return null; }
        }
        async function loadCategories() {
            try {
                const res = await fetch('/categories_staff');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                const select = document.getElementById('categoryFilter');
                select.innerHTML = '<option value="all">All Types</option>';
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.category_name;
                    opt.textContent = cat.category_name;
                    select.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading categories:", error);
            }
        }
        async function loadDormitories() {
            try {
                const staffDormName = await getStaffDormitoryName();
                const res = await fetch('/dormitories');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                const data = await res.json();
                const select = document.getElementById('locationFilter');
                select.innerHTML = '<option value="all">All Dormitories</option>';
                data.forEach(dorm => {
                    const opt = document.createElement('option');
                    opt.value = dorm.dorm_name;
                    opt.textContent = dorm.dorm_name;
                    select.appendChild(opt);
                });
                const lastDorm = getDormFromLocalStorage();
                let defaultDorm = lastDorm || staffDormName;
                if (defaultDorm && Array.from(select.options).some(opt => opt.value === defaultDorm)) {
                    select.value = defaultDorm;
                }
            } catch (error) {
                console.error("Error loading dormitories:", error);
            }
        }
        function formatDate(str) {
            if (!str) return '-';
            const d = new Date(str);
            if (isNaN(d.getTime())) return "-";
            return d.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }
        function formatTimeAMPM(str) {
            if (!str) return '-';
            const d = new Date(str);
            if (isNaN(d.getTime())) return "-";
            let hours = d.getHours();
            let minutes = d.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12;
            const minutesStr = minutes < 10 ? '0' + minutes : minutes;
            return hours + ':' + minutesStr + ' ' + ampm;
        }
        async function loadEvents() {
            if (!window._initialScheduleLoaded) return;
            const dormitory = document.getElementById("locationFilter").value;
            const category = document.getElementById("categoryFilter").value;
            const flatpickrInstance = document.getElementById("monthYearPicker")._flatpickr;
            const flatpickrDate = flatpickrInstance ? flatpickrInstance.selectedDates[0] : new Date();
            const month = flatpickrDate.getMonth() + 1;
            const year = flatpickrDate.getFullYear();
            let url = `/staff/schedule?year=${year}&month=${month}`;
            if (dormitory !== "all") url += `&dormitory=${encodeURIComponent(dormitory)}`;
            if (category !== "all") url += `&category=${encodeURIComponent(category)}`;
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    if (res.status === 404) {
                        events = [];
                        console.log("No events found for the selected filters.");
                    } else {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                } else {
                    const dbEvents = await res.json();
                    events = dbEvents.map(e => ({
                        day: new Date(e.repair_date).getDate(),
                        month: new Date(e.repair_date).getMonth() + 1,
                        year: new Date(e.repair_date).getFullYear(),
                        Room: e.room_number,
                        tec: e.technician_name || "-",
                        name: e.student_name,
                        dormitory: e.dorm_name,
                        repairType: e.category_name,
                        durable: e.article,
                        description: e.description,
                        requestDate: formatDate(e.request_date),
                        requestTime: formatTimeAMPM(e.request_date),
                        repairDate: formatDate(e.repair_date),
                        repairTime: formatTimeAMPM(e.repair_date),
                        status: e.status,
                        head: e.headtech_name || "-",
                        Image: e.image
                            ? (e.image.startsWith('/public/') ? e.image : '/public/uploads/' + e.image)
                            : '/public/img/no-image.png',
                        phone: e.phone_number || "-",
                        repairDateRaw: e.repair_date
                    }));
                }
            } catch (error) {
                console.error("Error loading events:", error);
                events = [];
            } finally {
                renderCalendar();
            }
        }
        function renderCalendar() {
            const calendar = document.getElementById("calendarGrid");
            calendar.innerHTML = "";
            const selectedCategory = document.getElementById("categoryFilter").value;
            const selectedDorm = document.getElementById("locationFilter").value;
            const daysOfWeek = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
            daysOfWeek.forEach(day => {
                const dayLabel = document.createElement("div");
                dayLabel.className = "day-label";
                dayLabel.textContent = day;
                calendar.appendChild(dayLabel);
            });
            const firstDay = new Date(selectedYear, selectedMonth, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement("div");
                emptyCell.classList.add("empty-day");
                calendar.appendChild(emptyCell);
            }
            for (let date = 1; date <= daysInMonth; date++) {
                const dayCell = document.createElement("div");
                dayCell.classList.add("day-cell");
                const dateNumber = document.createElement("div");
                dateNumber.className = "date-number";
                dateNumber.textContent = date;
                dayCell.appendChild(dateNumber);
                let dayEvents = events.filter(e =>
                    e.day === date &&
                    e.month === (selectedMonth + 1) &&
                    e.year === selectedYear &&
                    (selectedCategory === "all" || (e.repairType && e.repairType.toLowerCase().replace(/\s+/g, '') === selectedCategory.toLowerCase().replace(/\s+/g, ''))) &&
                    (selectedDorm === "all" || (e.dormitory && e.dormitory === selectedDorm))
                );
                dayEvents.sort((a, b) => {
                    return new Date(a.repairDateRaw) - new Date(b.repairDateRaw);
                });
                dayEvents.forEach(event => {
                    const eventDiv = document.createElement("div");
                    eventDiv.classList.add("event");
                    const className = event.repairType ? event.repairType.toLowerCase().replace(/\s+/g, '') : "";
                    eventDiv.classList.add(className);
                    eventDiv.innerHTML = `
                        <div><b>${event.repairTime}</b></div>
                        ${event.durable || '-'}<br/>
                        Room: ${event.Room || '-'}<br/>
                        Tech: ${event.tec || '-'}
                    `;
                    eventDiv.addEventListener("click", () => {
                        document.getElementById("modalName").textContent = event.name || "-";
                        document.getElementById("modalDormitory").textContent = event.dormitory || "-";
                        document.getElementById("modalRoom").textContent = event.Room || "-";
                        document.getElementById("modalRepairType").textContent = event.repairType || "-";
                        document.getElementById("modalDurable").textContent = event.durable || "-";
                        document.getElementById("modalDescription").textContent = event.description || "-";
                        document.getElementById("phone").textContent = event.phone || "-";
                        document.getElementById("modalHead").textContent = event.head || "-";
                        const modalImage = document.getElementById("modalImage");
                        modalImage.src = event.Image;
                        modalImage.style.display = event.Image && event.Image !== '/public/img/no-image.png' ? "block" : "none";
                        document.getElementById("modalRequestDate").textContent = event.requestDate || "-";
                        document.getElementById("modalRequestTime").textContent = event.requestTime || "-";
                        document.getElementById("modalRepairDate").textContent = event.repairDate || "-";
                        document.getElementById("modalRepairTime").textContent = event.repairTime || "-";
                        document.getElementById("modalStatus").textContent = event.status || "-";
                        document.getElementById("modalTech").textContent = event.tec || "-";
                        new bootstrap.Modal(document.getElementById("eventModal")).show();
                    });
                    dayCell.appendChild(eventDiv);
                });
                calendar.appendChild(dayCell);
            }
            const totalCells = startDay + daysInMonth;
            const remainder = totalCells % 7;
            if (remainder !== 0) {
                for (let i = 0; i < (7 - remainder); i++) {
                    const emptyCell = document.createElement("div");
                    emptyCell.classList.add("empty-day");
                    calendar.appendChild(emptyCell);
                }
            }
        }
        flatpickr("#monthYearPicker", {
            plugins: [new monthSelectPlugin({ shorthand: true, dateFormat: "F Y", altFormat: "F Y" })],
            defaultDate: new Date(),
            onChange: ([date]) => {
                if (date) {
                    selectedMonth = date.getMonth();
                    selectedYear = date.getFullYear();
                    loadEvents();
                }
            }
        });

        // ---- Notification Logic (เหมือนของ navbar) ----
        let allNotifications = [];
        let filterType = "all"; // "all" or "unread"

        function formatDateDMYHM(dateStr) {
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            let hour = d.getHours();
            let min = String(d.getMinutes()).padStart(2, '0');
            let ampm = "AM";
            if (hour >= 12) {
                ampm = "PM";
                if (hour > 12) hour -= 12;
            }
            if (hour === 0) hour = 12;
            return `${day}/${month}/${year} ${hour}:${min} ${ampm}`;
        }

        function renderNotifications() {
            const notificationList = document.getElementById("notificationList");
            const notificationCount = document.getElementById("notificationCount");
            let filtered = [];
            if (filterType === "unread") {
                filtered = allNotifications.filter(n => n.is_read === 0);
            } else {
                filtered = allNotifications;
            }

            notificationList.innerHTML = "";
            if (filtered.length === 0) {
                notificationList.innerHTML = `<li class="px-3 py-2 text-muted small">No notifications</li>`;
                return;
            }

            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            filtered.forEach(noti => {
                const li = document.createElement("li");
                li.className =
                    "px-3 py-2 small border-bottom cursor-pointer " +
                    (noti.is_read === 0
                        ? "bg-warning-subtle text-dark"
                        : "bg-white text-muted");

                li.innerHTML = `
                    <div class="fw-bold">${noti.title || ""}</div>
                    <div class="fw-normal">${noti.message || ""}</div>
                    <div class="small text-secondary">${formatDateDMYHM(noti.created_at)}</div>
                `;

                li.addEventListener("click", async () => {
                    await fetch("/staff/notifications/read", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ notification_id: noti.notification_id })
                    });
                    noti.is_read = 1;
                    renderNotifications();
                    updateNotificationCount();
                    if (noti.link) {
                        window.location.href = noti.link;
                    }
                });

                notificationList.appendChild(li);
            });
        }

        async function fetchNotifications() {
            try {
                const res = await fetch("/staff/notifications");
                if (!res.ok) throw new Error("Failed to fetch");
                const data = await res.json();
                allNotifications = data;
                renderNotifications();
                updateNotificationCount();
            } catch (err) {
                console.error(err);
            }
        }

        function updateNotificationCount() {
            const notificationCount = document.getElementById("notificationCount");
            const unread = allNotifications.filter(n => n.is_read === 0).length;
            if (unread > 0) {
                notificationCount.textContent = unread;
                notificationCount.classList.remove("d-none");
            } else {
                notificationCount.classList.add("d-none");
            }
        }

        function setupNotificationEvents() {
            const notificationBtn = document.getElementById("notificationBtn");
            const notificationDropdown = document.getElementById("notificationDropdown");
            const markAllAsReadBtn = document.getElementById("markAllAsReadBtn");
            const allNotiBtn = document.getElementById("allNotiBtn");
            const unreadNotiBtn = document.getElementById("unreadNotiBtn");

            if (!notificationBtn || !notificationDropdown) return;
            notificationBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                notificationDropdown.style.display =
                    notificationDropdown.style.display === "block" ? "none" : "block";
                renderNotifications();
            });

            document.addEventListener("click", (e) => {
                if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                    notificationDropdown.style.display = "none";
                }
            });

            if (markAllAsReadBtn) {
                markAllAsReadBtn.addEventListener("click", async function () {
                    try {
                        await fetch('/staff/notifications/read-all', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        await fetchNotifications();
                    } catch (e) {
                        console.error(e);
                    }
                });
            }

            if (allNotiBtn && unreadNotiBtn) {
                allNotiBtn.addEventListener("click", function () {
                    filterType = "all";
                    allNotiBtn.classList.add("active");
                    unreadNotiBtn.classList.remove("active");
                    renderNotifications();
                });

                unreadNotiBtn.addEventListener("click", function () {
                    filterType = "unread";
                    allNotiBtn.classList.remove("active");
                    unreadNotiBtn.classList.add("active");
                    renderNotifications();
                });
            }
        }

        window.addEventListener("DOMContentLoaded", async () => {
            showLoaderContent();

            // Load Navbar and Sidebar (Navbar includes notification bell & dropdown)
            const navbarPromise = fetch('/staff/nevbar')
                .then(res => res.text())
                .then(data => {
                    const temp = document.createElement('div');
                    temp.innerHTML = data;

                    const navbar = temp.querySelector('.navbar');
                    const tabs = temp.querySelector('.tabs');
                    const logoutModal = temp.querySelector('#logoutModal');

                    if (navbar) document.getElementById('navbar').appendChild(navbar);
                    if (tabs) document.getElementById('sidebar').appendChild(tabs);
                    if (logoutModal) document.body.appendChild(logoutModal);

                    fetch('/staff/nevbar_name')
                        .then(res => res.json())
                        .then(data => {
                            const navName = document.getElementById('nav-name');
                            if (navName) navName.textContent = data.name;
                        })
                        .catch(() => {
                            const navName = document.getElementById('nav-name');
                            if (navName) navName.textContent = "Staff";
                        });

                    window.toggleSidebar = function () {
                        const sidebar = document.querySelector(".tabs");
                        const body = document.body;
                        sidebar.classList.toggle("collapsed");
                        body.classList.toggle("sidebar-collapsed");
                    };

                    window.showLogoutModal = function () {
                        const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
                        modal.show();
                    };

                    window.handleLogout = function () {
                        fetch('/logout', { method: 'POST', credentials: 'include' })
                            .then(() => window.location.href = "/logout");
                    };

                    const currentPath = window.location.pathname;
                    document.querySelectorAll('.tab-item').forEach(item => {
                        const href = item.getAttribute('href');
                        if (href && currentPath.startsWith(href)) item.classList.add('active');
                    });

                    // ---- Notification bell logic ----
                    setTimeout(() => {
                        setupNotificationEvents();
                        fetchNotifications();
                        setInterval(fetchNotifications, 30000);
                    }, 100);
                });

            await loadDormitories();
            await loadCategories();

            setTimeout(() => {
                hideLoaderContent();
                window._initialScheduleLoaded = true;
                loadEvents();
            }, 1000);

            document.getElementById('locationFilter').addEventListener('change', (e) => {
                saveDormToLocalStorage(e.target.value);
                loadEvents();
            });
            document.getElementById('categoryFilter').addEventListener('change', loadEvents);
        });
    </script>
</body>

</html>