<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon" />
    <title>History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        html,
        body {
            overflow-x: hidden;
            margin: 0;
        }
    </style>
</head>

<body class="bg-white text-gray-900">

    <div id="navbar-container"></div>

    <main class="max-w-6xl mx-auto px-2 py-2">
        <h1 class="text-3xl font-bold mb-6">History</h1>

        <!-- Search & Filter -->
        <div class="flex flex-col sm:flex-row sm:flex-wrap gap-4 mb-4">
            <!-- Search Input -->
            <div class="relative w-full sm:flex-1">
                <input id="searchInput" type="text" placeholder="Search..."
                    class="w-full border px-4 py-2 rounded shadow-sm" />
                <i class="fa fa-search absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Date Input -->
            <div class="w-full sm:w-auto">
                <input id="dateInput" type="date" class="w-full border px-3 py-2 rounded shadow-sm" />
            </div>

            <!-- Repair Type Dropdown -->
            <div class="w-full sm:w-auto">
                <select id="typeFilter" class="w-full border px-3 py-2 rounded shadow-sm">
                    <option value="">All Repair Types</option>
                    <!-- Options will be filled dynamically -->
                </select>
            </div>

            <!-- Status Dropdown -->
            <div class="w-full sm:w-auto">
                <select id="statusFilter" class="w-full border px-3 py-2 rounded shadow-sm">
                    <option value="">All Status</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancel">Cancel</option>
                </select>
            </div>
        </div>



        <!-- Table Header -->
        <div class="hidden md:grid grid-cols-6 font-semibold border-b pb-2 text-sm text-gray-600">
            <div class="col-span-2">Item</div>
            <div>Repair Type</div>
            <div>Request Date</div>
            <div>Technician</div>
            <div>Completed Date</div>
        </div>


        <div id="history-loading"></div>

        <!-- Dynamic Content -->
        <div id="history-container" class="mt-4"></div>
    </main>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg max-w-5xl w-full mx-4 relative">
            <div class="flex justify-between items-center px-4 py-2 border-b">
                <h2 class="text-lg font-semibold">Photo Viewer</h2>
                <button onclick="closeImageModal()" class="text-gray-500 hover:text-red-600 text-xl">&times;</button>
            </div>
            <div class="overflow-auto p-4" style="max-height: 75vh;">
                <img id="modalImage" class="rounded shadow transition-transform duration-300 cursor-zoom-in"
                    style="max-width: 100%; max-height: 100%; transform-origin: center center;" />
            </div>
        </div>
    </div>

    <script>
        // Load Navbar HTML
        fetch("/views/student/student_navbar.html")
            .then(res => res.text())
            .then(html => {
                document.getElementById("navbar-container").innerHTML = html;

                // Wait until navbar is in DOM
                setTimeout(() => {
                    // ====== Elements ======
                    const userBtn = document.getElementById("userBtn");
                    const userDropdown = document.getElementById("userDropdown");
                    const notificationBtn = document.getElementById("notificationBtn");
                    const notificationDropdown = document.getElementById("notificationDropdown");
                    const logoutModal = document.getElementById("logoutModal");
                    const cancelLogout = document.getElementById("cancelLogout");
                    const badge = document.getElementById("notificationCount");
                    const allTab = document.getElementById("allTab");
                    const unreadTab = document.getElementById("unreadTab");

                    let currentTab = "all";

                    // ====== Load student name ======
                    fetch("/student/info")
                        .then(res => res.json())
                        .then(info => {
                            document.getElementById("studentName").innerText = info.name;
                        })
                        .catch(() => {
                            document.getElementById("studentName").innerText = "Student";
                        });

                    fetchNotifications();

                    // ====== Dropdown Toggle ======
                    userBtn?.addEventListener("click", (e) => {
                        e.stopPropagation();
                        notificationDropdown?.classList.add("hidden");
                        userDropdown?.classList.toggle("hidden");
                    });

                    notificationBtn?.addEventListener("click", (e) => {
                        e.stopPropagation();
                        userDropdown?.classList.add("hidden");
                        notificationDropdown?.classList.toggle("hidden");
                        fetchNotifications(); // fetch when clicked
                    });

                    document.addEventListener("click", (event) => {
                        if (!userDropdown.contains(event.target) && !userBtn.contains(event.target)) {
                            userDropdown.classList.add("hidden");
                        }
                        if (!notificationDropdown.contains(event.target) && !notificationBtn.contains(event.target)) {
                            notificationDropdown.classList.add("hidden");
                        }
                    });

                    // ====== Logout Modal ======
                    const logoutBtn = document.querySelector("#userDropdown button");
                    logoutBtn?.addEventListener("click", () => {
                        logoutModal?.classList.remove("hidden");
                        logoutModal?.classList.add("flex");
                    });

                    cancelLogout?.addEventListener("click", () => {
                        logoutModal?.classList.remove("flex");
                        logoutModal?.classList.add("hidden");
                    });

                    // ====== Fetch Notifications ======
                    // ====== Tabs ======
                    function setActiveTab(tab) {
                        if (tab === "all") {
                            allTab.className = "px-3 py-1 text-sm rounded-full font-medium bg-blue-600 text-white";
                            unreadTab.className = "px-3 py-1 text-sm rounded-full font-medium bg-gray-200 text-gray-700 hover:bg-gray-300";
                        } else {
                            unreadTab.className = "px-3 py-1 text-sm rounded-full font-medium bg-blue-600 text-white";
                            allTab.className = "px-3 py-1 text-sm rounded-full font-medium bg-gray-200 text-gray-700 hover:bg-gray-300";
                        }
                    }

                    allTab?.addEventListener("click", () => {
                        currentTab = "all";
                        setActiveTab("all");
                        fetchNotifications();
                    });

                    unreadTab?.addEventListener("click", () => {
                        currentTab = "unread";
                        setActiveTab("unread");
                        fetchNotifications();
                    });

                    const markAllReadBtn = document.getElementById("markAllRead");
                    markAllReadBtn?.addEventListener("click", async () => {
                        await fetch("/notifications/read-all", { method: "POST" });
                        fetchNotifications();
                    });

                    function formatDateTime(dateString) {
                        const date = new Date(dateString);

                        // Format: DD/MM/YY HH:mm
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = String(date.getFullYear()).slice(-2);
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');

                        return `${day}/${month}/${year} ${hours}:${minutes}`;
                    }


                    // Icon mapping by notification title
                    const iconMap = {
                        "Repair Request Confirmed": { icon: "fa-wrench", color: "text-blue-500" },
                        "Repair Request Updated": { icon: "fa-edit", color: "text-yellow-500" },
                        "Repair Completed": { icon: "fa-check-circle", color: "text-green-500" }
                    };

                    async function fetchNotifications() {
                        try {
                            const res = await fetch('/student/notifications');
                            if (!res.ok) throw new Error('Failed to fetch notifications');
                            const data = await res.json();

                            const list = document.querySelector('#notificationDropdown ul');
                            const badge = document.getElementById('notificationCount');
                            list.innerHTML = '';

                            if (!data || data.length === 0) {
                                list.innerHTML = `<li class="px-4 py-2 text-sm text-gray-500">No new notifications</li>`;
                                badge.classList.add('hidden');
                                return;
                            }

                            // âœ… Apply filter by tab
                            let filtered = data;
                            if (currentTab === "unread") {
                                filtered = data.filter(n => n.is_read === 0);
                            }

                            if (filtered.length === 0) {
                                list.innerHTML = `<li class="px-4 py-2 text-sm text-gray-500">No notifications</li>`;
                                return;
                            }

                            filtered.forEach(noti => {
                                // Pick icon from mapping, default to bell
                                const { icon, color } = iconMap[noti.title] || { icon: "fa-bell", color: "text-gray-500" };

                                const li = document.createElement('li');
                                li.className =
                                    "px-4 py-2 text-sm border-b cursor-pointer flex items-start space-x-3 " +
                                    (noti.is_read === 0
                                        ? "bg-gray-200 font-semibold text-red-600 hover:bg-gray-300"
                                        : "bg-white text-gray-600 hover:bg-gray-100");

                                li.innerHTML = `
                <i class="fas ${icon} ${color} mt-1"></i>
                <div class="flex-1">
                    <div class="font-semibold">${noti.title}</div>
                    <div class="text-xs text-gray-500">${noti.message || ''}</div>
                    <div class="text-[10px] text-gray-400">${formatDateTime(noti.created_at)}</div>
                </div>
            `;

                                li.addEventListener('click', async () => {
                                    if (noti.link) window.location.href = noti.link;

                                    await fetch('/notifications/read', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ notification_id: noti.notification_id })
                                    });

                                    fetchNotifications();
                                });

                                list.appendChild(li);
                            });

                            // Update badge count
                            const unreadCount = data.filter(n => n.is_read === 0).length;
                            if (unreadCount > 0) {
                                badge.textContent = unreadCount;
                                badge.classList.remove('hidden');
                            } else {
                                badge.classList.add('hidden');
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    }

                    // Auto refresh every 30s
                    setInterval(fetchNotifications, 30000);
                }, 0);
            });

        // Zoom modal
        let zoomedIn = false;
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('hidden');
            modalImg.src = src;
            modalImg.style.transform = "scale(1)";
            zoomedIn = false;
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
        }

        document.addEventListener("DOMContentLoaded", () => {
            const modalImg = document.getElementById('modalImage');
            modalImg.addEventListener('click', function () {
                zoomedIn = !zoomedIn;
                this.style.transform = zoomedIn ? "scale(2)" : "scale(1)";
                this.style.cursor = zoomedIn ? "zoom-out" : "zoom-in";
            });

            let allData = [];

            function renderFilteredData(data) {
                const container = document.getElementById("history-container");
                if (data.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500 mt-8">No Results.</p>`;
                    return;
                }

                const cards = data.map(item => {
                    const image = item.image ? item.image.replace("/public", "") : "/img/default.png";
                    const techName = item.tech_name || "-";
                    const phone = item.phone_number || "-";

                    const requestDate = new Date(item.request_date);
                    const completeDate = item.complete_date ? new Date(item.complete_date) : null;

                    const requestTime = requestDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const completeTime = completeDate ? completeDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "";

                    const completeDisplay = item.status === "Cancel"
                        ? `<span class="font-semibold text-red-600">Cancel!</span>`
                        : `${completeDate.toLocaleDateString('en-GB')}<br><span class="text-xs text-gray-500">${completeTime}</span>`;

                    const stars = [...Array(5)].map((_, i) =>
                        `<i class="${i < item.rating ? 'fas' : 'far'} fa-star"></i>`
                    ).join('');

                    return `
                    <div class="border rounded-lg p-4 my-4 shadow-sm">
                        <!-- Mobile View -->
                        <div class="md:hidden space-y-2 text-sm">
                            <div class="flex items-center gap-3">
                                <img src="${image}" alt="${item.article}" class="w-14 h-14 rounded object-cover cursor-pointer hover:scale-105 transition-transform" onclick="openImageModal(this.src)" />
                                <div>
                                    <p class="font-semibold">Item:</p>
                                    <p>${item.article}</p>
                                </div>
                            </div>
                            <p><span class="font-semibold">Repair Type:</span> ${item.category_name}</p>
                            <p><span class="font-semibold">Request Date:</span> ${requestDate.toLocaleDateString('en-GB')} ${requestTime}</p>
                            <p><span class="font-semibold">Technician:</span> ${techName}<br />
                                <span class="text-xs text-gray-500">${phone}</span>
                            </p>
                            <p><span class="font-semibold">Completed Date:</span> ${item.status === "Cancel" ? `<span class="text-red-600 font-semibold">Cancel!</span>` : `${completeDate.toLocaleDateString('en-GB')} ${completeTime}`}</p>
                        </div>

                        <!-- Desktop View -->
                        <div class="hidden md:grid grid-cols-6 gap-4 items-center text-sm md:text-base">
                            <div class="col-span-2 flex items-center gap-3">
                                <img src="${image}" alt="${item.article}" class="w-14 h-14 rounded object-cover cursor-pointer hover:scale-105 transition-transform" onclick="openImageModal(this.src)" />
                                <span class="font-medium">${item.article}</span>
                            </div>
                            <div>${item.category_name}</div>
                            <div>${requestDate.toLocaleDateString('en-GB')}<br><span class="text-xs text-gray-500">${requestTime}</span></div>
                            <div>${techName}<br /><span class="text-xs text-gray-500">${phone}</span></div>
                            <div>${completeDisplay}</div>
                        </div>

                        <button onclick="toggleDetails(this)" class="mt-3 text-red-600 hover:text-red-800 font-semibold hover:underline transition">
                            Show more details
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <div class="mt-3 border-t pt-3 hidden text-sm">
                            <p><strong>Dormitory:</strong> ${item.dorm_name} &nbsp;&nbsp; <strong>Room Number:</strong> ${item.room_number}</p>
                            <p class="mt-2"><strong>Damage Description:</strong> ${item.description}</p>
                            ${item.rating ? `<p class="mt-2 text-yellow-500 text-lg">${stars}<span class="text-gray-700 text-sm"> ${item.comment}</span></p>` : ``}
                        </div>
                    </div>`;
                }).join("");

                container.innerHTML = cards;
            }

            function filterData() {
                const keyword = document.getElementById("searchInput").value.toLowerCase();
                const selectedDate = document.getElementById("dateInput").value;
                const selectedType = document.getElementById("typeFilter").value.toLowerCase();
                const selectedStatus = document.getElementById("statusFilter").value;

                const filtered = allData.filter(item => {
                    const article = item.article?.toLowerCase() || "";
                    const type = item.category_name?.toLowerCase() || "";
                    const dorm = item.dorm_name?.toLowerCase() || "";
                    const room = item.room_number?.toLowerCase() || "";
                    const desc = item.description?.toLowerCase() || "";
                    const tech = item.tech_name?.toLowerCase() || "";

                    const requestDate = new Date(item.request_date).toISOString().split("T")[0];
                    const completeDate = item.complete_date ? new Date(item.complete_date).toISOString().split("T")[0] : "";

                    const matchKeyword = [article, dorm, room, desc, tech].some(text => text.includes(keyword));
                    const matchDate = !selectedDate || requestDate === selectedDate || completeDate === selectedDate;
                    const matchType = !selectedType || type === selectedType;
                    const matchStatus = !selectedStatus || item.status === selectedStatus;

                    return matchKeyword && matchDate && matchType && matchStatus;
                });

                renderFilteredData(filtered);
            }

            // STEP 1: Show loading.html before fetching data
            fetch("/views/loading.html")
                .then(res => res.text())
                .then(loaderHTML => {
                    document.getElementById("history-container").innerHTML = loaderHTML;

                    // STEP 2: Then fetch actual history data
                    return fetch("/student/history-data");
                })
                .then(res => res.json())
                .then(data => {
                    allData = data;

                    // STEP 3: Replace loading with actual data
                    renderFilteredData(allData);

                    // STEP 4: Populate repair type dropdown
                    const types = [...new Set(data.map(item => item.category_name).filter(Boolean))];
                    const typeSelect = document.getElementById("typeFilter");
                    types.forEach(type => {
                        const opt = document.createElement("option");
                        opt.value = type.toLowerCase();
                        opt.textContent = type;
                        typeSelect.appendChild(opt);
                    });
                });




            document.getElementById("searchInput").addEventListener("input", filterData);
            document.getElementById("dateInput").addEventListener("change", filterData);
            document.getElementById("typeFilter").addEventListener("change", filterData);
            document.getElementById("statusFilter").addEventListener("change", filterData);



        });

        function toggleDetails(button) {
            const detailDiv = button.nextElementSibling;
            const isHidden = detailDiv.classList.contains('hidden');
            detailDiv.classList.toggle('hidden');
            button.innerHTML = isHidden
                ? `Hide details <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block transform rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`
                : `Show more details <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>`;
        }
    </script>
</body>

</html>