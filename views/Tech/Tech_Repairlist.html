<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Repair List</title>
    <script src="/public/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/public/css/Tech/Tech_Repair.css" />
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon" />
    <style>
        .repair-container {
            position: relative;
        }

        #content-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fffbe9e0;
            /* สีเดียวกับ bg หลักและ Loading.html */
            z-index: 50;
            display: none;
            align-items: flex-start;
            /* <-- เปลี่ยนจาก center เป็น flex-start */
            justify-content: center;
        }

        .center-loader-container {
            /* ปรับตำแหน่งให้อยู่ข้างบนมากขึ้น */
            position: relative;
            /* เปลี่ยนเป็น relative เพื่อใช้ margin */
            left: 0;
            top: 0;
            transform: none;
            margin-top: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        /* Loader CSS จาก Loading.html */
        .loader-visual {
            --c1: #673b14;
            --c2: #f8b13b;
            width: 40px;
            height: 80px;
            border-top: 4px solid var(--c1);
            border-bottom: 4px solid var(--c1);
            background: linear-gradient(90deg, var(--c1) 2px, var(--c2) 0 5px, var(--c1) 0) 50%/7px 8px no-repeat;
            display: grid;
            overflow: hidden;
            animation: l5-0 2s infinite linear;
        }

        .loader-visual::before,
        .loader-visual::after {
            content: "";
            grid-area: 1/1;
            width: 75%;
            height: calc(50% - 4px);
            margin: 0 auto;
            border: 2px solid var(--c1);
            border-top: 0;
            box-sizing: content-box;
            border-radius: 0 0 40% 40%;
            -webkit-mask:
                linear-gradient(#000 0 0) bottom/4px 2px no-repeat,
                linear-gradient(#000 0 0);
            -webkit-mask-composite: destination-out;
            mask-composite: exclude;
            background:
                linear-gradient(var(--d, 0deg), var(--c2) 50%, #0000 0) bottom /100% 205%,
                linear-gradient(var(--c2) 0 0) center/0 100%;
            background-repeat: no-repeat;
            animation: inherit;
            animation-name: l5-1;
        }

        .loader-visual::after {
            transform-origin: 50% calc(100% + 2px);
            transform: scaleY(-1);
            --s: 3px;
            --d: 180deg;
        }

        @keyframes l5-0 {
            80% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(0.5turn)
            }
        }

        @keyframes l5-1 {

            10%,
            70% {
                background-size: 100% 205%, var(--s, 0) 100%
            }

            70%,
            100% {
                background-position: top, center
            }
        }

        .loader-text {
            width: fit-content;
            font-weight: bold;
            font-family: monospace;
            font-size: 30px;
            clip-path: inset(0 3ch 0 0);
            animation: l4 1s steps(4) infinite;
            color: #673b14;
            background: #fffbe9;
            padding: 0.5em 1em;
            border-radius: 8px;
            box-shadow: 0 4px 16px #f8b13b33;
            margin-top: 32px;
        }

        .loader-text:before {
            content: "Loading...";
        }

        @keyframes l4 {
            to {
                clip-path: inset(0 -1ch 0 0)
            }
        }

        #alertModal .modal-content {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #alertModal .modal-content:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        #alertModal .btn-warning {
            background: linear-gradient(135deg, #ffc107, #ffca2c);
            border: none;
        }

        #alertModal .btn-warning:hover {
            background: lin ear-gradient(135deg, #ffca2c, #ffc107);
        }

        .is-invalid {
            border: 2px solid #dc3545 !important;
            /* Bootstrap danger */
            box-shadow: 0 0 0 0.15rem rgba(220, 53, 69, 0.25);
        }
    </style>
</head>

<body>
    <div id="navbar-placeholder"></div>
    <main class="repair-container">
        <div id="content-loading-overlay"></div>
        <div class="container mt-4 mb-5">
            <h2 class="fw-bold mb-4 ps-5">Repair List</h2>
            <div class="row g-4" id="repairCardList">
                <!-- Cards will be rendered here by JS -->
            </div>
        </div>
    </main>
    <!-- Modal -->
    <div class="modal fade" id="repairDetailModal" tabindex="-1" aria-labelledby="repairDetailLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content p-3 rounded-3">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="repairDetailLabel">Repair Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body-content"></div>
                <div class="modal-footer border-0">
                    <button class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Mark as Repaired -->
    <div class="modal fade" id="markRepairedModal" tabindex="-1" aria-labelledby="markRepairedModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 rounded-3">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="markRepairedModalLabel">Mark as Repaired</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentRequestId" />
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Status</label>
                        <select class="form-select" disabled>
                            <option selected>Completed</option>
                        </select>
                        <div class="text-danger mt-2" style="font-size: 0.9rem;">
                            <i class="bi bi-exclamation-circle"></i>
                            This status will be updated automatically after repair is marked.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="correctionMethod" class="form-label fw-semibold">Correction Method</label>
                        <textarea id="correctionMethod" class="form-control" rows="4"
                            placeholder="e.g. I replaced the screen and secured the frame properly."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmRepairedBtn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Photo Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Photo Viewer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="enlargedPhoto" src="" class="photo-modal-img img-fluid" alt="Enlarged photo">
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" id="prevPhotoBtn" style="display:none;">
                        <i class="bi bi-chevron-left"></i> Previous
                    </button>
                    <span id="photoCounter" style="display:none;"></span>
                    <button type="button" class="btn btn-secondary" id="nextPhotoBtn" style="display:none;">
                        Next <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Alert Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-header border-0 bg-warning text-dark">
                    <h5 class="modal-title fw-bold" id="alertModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Warning
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4" id="alertModalBody" style="font-size: 1rem; color: #444;">
                    <!-- The alert message will be inserted here -->
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-warning px-4 fw-bold" data-bs-dismiss="modal">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="/public/js/Tech/Tech.navbar-notification.js"></script>
    <script>
        let repairListData = [];
        let currentRequestId = null;

        function createRepairCard(card) {
            let imgName = card.image.replace(/^\/?public/, '');
            return `
        <div class="col-12 col-md-6 col-lg-5 col-xl-4 mb-4">
            <div class="card repair-card shadow-sm h-100">
                <div class="card-img-container position-relative">
                    <img src="${imgName}" class="card-img-top" alt="${card.article}" />
                    <div class="card-img-overlay d-flex justify-content-end align-items-start">
                        <span class="badge bg-primary">${card.status}</span>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="mb-2">
                        <h5 class="fw-bold mb-1">${card.name}</h5>
                        <p class="mb-1">
                            <i class="bi bi-geo-alt-fill me-1"></i>
                            <strong>Dorm ${card.dorm}, Room ${card.room}</strong>
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-primary">${card.type}</span>
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>${card.date}
                                <span class="ms-2"><i class="bi bi-alarm me-1"></i>${card.time}</span>
                            </small>
                        </div>
                    </div>
                    <div class="mb-3 flex-grow-1">
                        <p class="fw-semibold mb-1 text-muted">${card.article}</p>
                        <p class="card-text">${card.description}</p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <button class="btn btn-outline-success btn-sm mark-repaired-btn" data-id="${card.id}">
                            <i class="bi bi-check-circle me-1"></i>Mark as Repaired
                        </button>
                        <a href="#" class="text-danger fw-semibold text-decoration-none see-detail-btn"
                            data-id="${card.id}">see detail &gt;&gt;</a>
                    </div>
                </div>
            </div>
        </div>
    `;
        }
        function renderRepairList(repairListData) {
            const container = document.getElementById('repairCardList');
            if (repairListData.length === 0) {
                container.innerHTML = `<div class="text-center text-muted py-5">No confirmed repair jobs assigned to you at this time.</div>`;
            } else {
                container.innerHTML = repairListData.map(createRepairCard).join('');
            }
            attachCardEvents();
        }

        function attachCardEvents() {
            // See detail
            document.querySelectorAll('.see-detail-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const id = this.dataset.id;
                    const data = repairListData.find(item => item.id == id);

                    if (data) {
                        const modalBody = document.getElementById("modal-body-content");
                        modalBody.innerHTML = `
                            <table class="table table-bordered align-middle">
                              <tr><th>Request ID</th><td>${data.id}</td></tr>
                              <tr><th>Requester’s Name</th><td>${data.name}</td></tr>
                              <tr><th>Dormitory</th><td>${data.dorm}</td></tr>
                              <tr><th>Room Number</th><td>${data.room}</td></tr>
                              <tr><th>Assigned By</th><td>${data.assigned_by ? data.assigned_by : '-'}</td></tr>
                            </table>
                            <table class="table table-bordered align-middle mt-3">
                              <tr><th>Repair Type</th><td>${data.type}</td></tr>
                              <tr><th>Item</th><td>${data.article}</td></tr>
                              <tr><th>Damage Description</th><td>${data.description}</td></tr>
                              <tr><th>Photos</th><td>
                              <img src="${data.image.replace(/^\/?public/, '')}" class="img-fluid rounded repair-photo-thumbnail" style="max-width: 200px; cursor: pointer;"></td></tr>
                              <tr><th>Repair Date</th><td>${data.date}</td></tr>
                              <tr><th>Time</th><td>${data.time}</td></tr>
                              <tr><th>Status</th><td>${data.status}</td></tr>
                            </table>
                        `;
                        const detailModal = new bootstrap.Modal(document.getElementById('repairDetailModal'));
                        detailModal.show();

                        // Add event listener to the image inside the detail modal
                        const detailImage = modalBody.querySelector('.repair-photo-thumbnail');
                        if (detailImage) {
                            detailImage.addEventListener('click', function () {
                                openPhotoModal(this.src);
                            });
                        }
                    }
                });
            });

            // Mark as repaired
            document.querySelectorAll('.mark-repaired-btn').forEach(button => {
                button.addEventListener('click', function () {
                    document.getElementById('correctionMethod').value = '';
                    currentRequestId = this.dataset.id;
                    document.getElementById('currentRequestId').value = currentRequestId;
                    const modal = new bootstrap.Modal(document.getElementById('markRepairedModal'));
                    modal.show();
                });
            });

            // Card image modal
            document.querySelectorAll('.card-img-top').forEach(img => {
                img.style.cursor = 'pointer';
                img.addEventListener('click', function () {
                    openPhotoModal(this.src);
                });
            });
        }

        function openPhotoModal(imageUrl) {
            const photoModalElement = document.getElementById('photoModal');
            const enlargedPhoto = document.getElementById('enlargedPhoto');
            const photoModal = new bootstrap.Modal(photoModalElement);

            enlargedPhoto.src = imageUrl;
            enlargedPhoto.classList.remove('zoomed');
            document.getElementById('prevPhotoBtn').style.display = 'none';
            document.getElementById('nextPhotoBtn').style.display = 'none';
            document.getElementById('photoCounter').style.display = 'none';

            photoModal.show();
        }

        // Modal confirm logic
        document.getElementById('confirmRepairedBtn').addEventListener('click', function () {
            const correctionInput = document.getElementById('correctionMethod');
            const correction = correctionInput.value.trim();
            const requestId = document.getElementById('currentRequestId').value;

            // Reset border before check
            correctionInput.classList.remove('is-invalid');
            if (!correction) {
                correctionInput.classList.add('is-invalid'); // ใส่ขอบแดง
                showAlertModal('Please enter the correction method.');
                correctionInput.focus();
                return;
            }
            if (!requestId) {
                alert('No request selected.');
                return;
            }

            fetch('/tech/repairlist/mark-completed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    request_id: requestId,
                    work_description: correction
                })
            })
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('markRepairedModal')).hide();
                        // Reload repair list
                        fetch('/tech/repairlist/data')
                            .then(res => res.json())
                            .then(data => {
                                repairListData = data;
                                renderRepairList(repairListData);
                            });
                        // alert('Marked as repaired successfully!');
                    } else {
                        alert(result.message || 'Error marking as repaired.');
                    }
                })
                .catch(() => {
                    alert('Error marking as repaired.');
                });
        });

        // Zoom for enlarged photo
        const enlargedPhoto = document.getElementById('enlargedPhoto');
        let scale = 1;
        function setZoom(factor) {
            scale = Math.max(1, Math.min(4, scale * factor));
            enlargedPhoto.style.transform = `scale(${scale})`;
            enlargedPhoto.style.transition = 'transform 0.2s';
            enlargedPhoto.style.cursor = scale > 1 ? 'zoom-out' : 'zoom-in';
        }
        if (enlargedPhoto) {
            enlargedPhoto.addEventListener('click', function () {
                // toggle zoom: 1x => 2x, 2x => 1x
                if (scale === 1) setZoom(2);
                else setZoom(1);
            });
            // wheel zoom
            enlargedPhoto.addEventListener('wheel', function (e) {
                e.preventDefault();
                setZoom(e.deltaY < 0 ? 1.2 : 0.8);
            });
            // dblclick reset zoom
            enlargedPhoto.addEventListener('dblclick', function () {
                scale = 1;
                enlargedPhoto.style.transform = '';
                enlargedPhoto.style.cursor = 'zoom-in';
            });
        }
        const photoModalElement = document.getElementById('photoModal');
        if (photoModalElement) {
            photoModalElement.addEventListener('hidden.bs.modal', function () {
                scale = 1;
                enlargedPhoto.style.transform = '';
                enlargedPhoto.classList.remove('zoomed');
                enlargedPhoto.style.cursor = 'zoom-in';
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // Navbar/sidebar logic as before...
            fetch('/views/Tech/Tech_Navbar.html')
                .then(res => res.text())
                .then(data => {
                    document.getElementById('navbar-placeholder').innerHTML = data;
                    const navbarPlaceholder = document.getElementById('navbar-placeholder');
                    navbarPlaceholder.innerHTML = data;


                    const script = document.createElement('script');
                    script.src = '/public/js/Tech/Tech.navbar-notification.js';
                    document.body.appendChild(script);

                    const mobileMenuToggle = navbarPlaceholder.querySelector('.mobile-menu-toggle');
                    const sidebar = navbarPlaceholder.querySelector('.sidebar');
                    if (mobileMenuToggle && sidebar) {
                        mobileMenuToggle.addEventListener('click', function () {
                            sidebar.classList.toggle('open');
                            document.body.classList.toggle('sidebar-open');
                        });
                    }
                    navbarPlaceholder.querySelectorAll('.dropdown-toggle').forEach(dropdownToggleEl => {
                        new bootstrap.Dropdown(dropdownToggleEl);
                    });
                    const currentPath = window.location.pathname;
                    const sidebarLinks = navbarPlaceholder.querySelectorAll('.sidebar .menu li a');
                    sidebarLinks.forEach(link => {
                        const linkPath = link.pathname.replace(/^\/|\/$/g, '');
                        const currentPathNormalized = currentPath.replace(/^\/|\/$/g, '');
                        if (currentPathNormalized.includes(linkPath) && linkPath !== '') {
                            link.parentElement.classList.add('active');
                        } else if (currentPathNormalized === '' && linkPath === 'Head_Dashboard.html') {
                            link.parentElement.classList.add('active');
                        }
                        const logoutBtn = document.getElementById('logout-link');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                const modal = new bootstrap.Modal(document.getElementById('logoutConfirmModal'));
                                modal.show();
                            });
                        }
                        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
                        if (confirmLogoutBtn) {
                            confirmLogoutBtn.addEventListener('click', function () {
                                fetch('/logout', { method: 'GET', credentials: 'include' })
                                    .then(() => window.location.href = '/login')
                                    .catch(() => window.location.href = '/login');
                            });
                        }


                    });

                    document.addEventListener('click', function (e) {
                        if (window.innerWidth < 992 && sidebar && sidebar.classList.contains('open') &&
                            !sidebar.contains(e.target) &&
                            !mobileMenuToggle.contains(e.target)) {
                            sidebar.classList.remove('open');
                            document.body.classList.remove('sidebar-open');
                        }
                    });
                    window.addEventListener('resize', function () {
                        if (window.innerWidth >= 992) {
                            if (sidebar) sidebar.classList.remove('open');
                            document.body.classList.remove('sidebar-open');
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading navbar:', error);
                });
            fetch('/user/me', { credentials: "include" })
                .then(res => res.json())
                .then(user => {
                    const nameDiv = document.getElementById('userName');
                    const roleDiv = document.getElementById('userRole');
                    if (nameDiv) nameDiv.textContent = user.name;
                    if (roleDiv) roleDiv.textContent = user.role;
                })
                .catch(() => {
                    const nameDiv = document.getElementById('userName');
                    const roleDiv = document.getElementById('userRole');
                    if (nameDiv) nameDiv.textContent = 'Please log in to your account.';
                    if (roleDiv) roleDiv.textContent = '';
                });
            // ดึงข้อมูลจาก backend
            fetch('/tech/repairlist/data')
                .then(res => {
                    if (!res.ok) throw new Error("Unauthorized or no data");
                    return res.json();
                })
                .then(data => {
                    repairListData = data;
                    renderRepairList(repairListData);
                })
                .catch(err => {
                    document.getElementById('repairCardList').innerHTML = `<div class="text-center text-danger py-5">Cannot load repair list. Please log in as a technician.</div>`;
                });

            setTimeout(() => {
                const links = document.querySelectorAll('.sidebar .menu li a');
                const currentPath = window.location.pathname;
                links.forEach(link => {
                    const tempAnchor = document.createElement('a');
                    tempAnchor.href = link.getAttribute('href');
                    if (tempAnchor.pathname === currentPath) {
                        link.parentElement.classList.add('active');
                    }
                });
            }, 100);
        });
        async function showContentLoading() {
            const overlay = document.getElementById('content-loading-overlay');
            if (!overlay) return;
            overlay.style.display = 'flex';
            try {
                const res = await fetch('/loading');
                const html = await res.text();
                // ดึงเฉพาะ .center-loader-container ไม่ใช่ทั้ง html
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const loader = temp.querySelector('.center-loader-container');
                overlay.innerHTML = loader ? loader.outerHTML : "<div>Loading...</div>";
            } catch (e) {
                overlay.innerHTML = '<div style="color:#c00; font-size:1.5rem">Loading...</div>';
            }
        }
        function hideContentLoading() {
            const overlay = document.getElementById('content-loading-overlay');
            if (!overlay) return;
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.innerHTML = '';
                overlay.style.opacity = '1';
            }, 400);
        }

        document.addEventListener("DOMContentLoaded", function () {
            showContentLoading();
            // fetch data...
            setTimeout(hideContentLoading, 800);
        });
        function showAlertModal(message) {
            document.getElementById('alertModalBody').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('alertModal'));
            modal.show();
        }
        document.addEventListener('hidden.bs.modal', function (e) {
            // ลบ backdrop ที่อาจเหลืออยู่
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => {
                backdrop.remove();
            });
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        });

    </script>
</body>

</html>