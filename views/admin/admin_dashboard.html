<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MFU DormFix Dashboard</title>
    <link rel="shortcut icon" href="/public/img/MFU.png" type="image/x-icon">
    <link rel="stylesheet" href="/public/css/staff/dashboard_staff.css">
    <link rel="stylesheet" href="/public/css/staff/nav_bar_staff.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .dropdown-fb {
            position: fixed;
            top: 75px;
            right: 40px;
            width: 350px;
            background: #ffffff;
            border: 2px solid #f7d86e;
            border-radius: 18px;
            box-shadow: 0 6px 24px #0002;
            z-index: 3000;
            display: none;
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: box-shadow 0.2s;
        }
        .dropdown-fb.show {
            display: block !important;
        }
        .dropdown-fb-header {
            padding: 16px 20px 8px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #fae3a1;
        }
        .dropdown-fb-header .btn-link {
            background: none;
            border: none;
            color: #1976d2;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: underline;
        }
        .dropdown-fb-tabs {
            display: flex;
            padding: 8px 20px;
            gap: 10px;
            border-bottom: 1px solid #fae3a1;
        }
        .fb-tab {
            padding: 7px 22px;
            border-radius: 20px;
            border: none;
            background: #f7e7b9;
            font-weight: 500;
            color: #25408f;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
        }
        .fb-tab.active {
            background: #25408f;
            color: #fff;
            font-weight: bold;
        }
        .dropdown-fb-list {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 340px;
            overflow-y: auto;
        }
        .fb-noti-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 16px 22px 14px 22px;
            border-bottom: 1px solid #f7e7b9;
            background: #fffbe9;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .fb-noti-item.unread {
            background: #fff9e1;
        }
        .fb-noti-item.read {
            background: #f3f2f2;
            color: #aaa;
        }
        .fb-noti-top {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fb-noti-icon {
            font-size: 1.6rem;
            margin-right: 2px;
        }
        .fb-noti-title {
            font-weight: bold;
            font-size: 1.08rem;
            flex: 1;
        }
        .fb-noti-dot {
            width: 11px;
            height: 11px;
            background: #1976d2;
            border-radius: 50%;
            margin-left: 7px;
            margin-right: 2px;
            display: inline-block;
        }
        .fb-noti-date {
            font-size: 0.96rem;
            color: #888;
            margin-bottom: 2px;
        }
        .fb-noti-msg {
            font-size: 0.97rem;
            color: #444;
            margin-bottom: 1px;
        }
        .dropdown-fb-footer {
            padding: 12px 0;
            text-align: center;
            border-top: 1px solid #fae3a1;
            background: #fffbe9;
        }
        .fb-seeall {
            background: none;
            border: none;
            color: #1976d2;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: underline;
        }
        #notificationBtn .badge {
            font-size: 1rem;
            top: 2px;
            left: 22px;
            padding: 0 6px;
        }
    </style>
</head>
<body>
    <div id="navbar"></div>
    <div class="d-flex" style="flex: 1;">
        <div id="sidebar"></div>
        <div class="main-content">
            <div class="container" id="main-content-area">
                <div id="loading-overlay"></div>
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <select class="form-select rounded-pill px-4" id="dormSelect" style="width: 100%;">
                            </select>
                        </div>
                        <div>
                            <h2 class="update">Last Update : <span id="lastUpdate"></span></h2>
                        </div>
                    </div>
                    <div class="container">
                        <div class="row g-4 justify-content-center">
                            <div class="col-6 col-md-auto col-lg"><div class="card text-center p-3 h-100"><h5><i class="fa-solid fa-square-poll-horizontal fs-4 text-primary me-2"></i>Total Repair Requests</h5><h2>0</h2></div></div>
                            <div class="col-6 col-md-auto col-lg"><div class="card text-center p-3 h-100"><h5><i class="bi bi-hourglass-split fs-4 text-warning me-2"></i>Repair Pending</h5><h2>0</h2></div></div>
                            <div class="col-6 col-md-auto col-lg"><div class="card text-center p-3 h-100"><h5><i class="fa-solid fa-spinner fs-4 text-info me-2"></i>Repair Confirmed</h5><h2>0</h2></div></div>
                            <div class="col-6 col-md-auto col-lg"><div class="card text-center p-3 h-100"><h5><i class="bi bi-clipboard-check fs-4 text-success me-2"></i>Repair Completed</h5><h2>0</h2></div></div>
                            <div class="col-6 col-md-auto col-lg"><div class="card text-center p-3 h-100"><h5><i class="bi bi-x-circle fs-4 text-danger me-2"></i>Repair Cancel</h5><h2>0</h2></div></div>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h6 class="text-center">Top of Repair Requests</h6>
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-12 col-lg-4 mb-4">
                            <div class="card p-3 chart">
                                <h6 class="text-center">Top 5 Rooms with Most Repairs</h6>
                                <div class="chart-container">
                                    <canvas id="roomRepairChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-4 p-3">
                        <h6>Recent Repair Completed</h6>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Request Date</th>
                                        <th>Reporter's Name</th>
                                        <th>Item</th>
                                        <th>Damage Description</th>
                                        <th>Room</th>
                                        <th>Technician</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let barChartInstance = null;
let roomChartInstance = null;

function showLoaderContent() {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'flex';
    overlay.innerHTML = '';
    document.body.classList.add('loading-active');
    fetch('/loading')
        .then(res => res.text())
        .then(html => {
            overlay.innerHTML = `<div class="loader-content">${html}</div>`;
            overlay.style.background = '#fffbe9';
        });
}

function hideLoaderContent() {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'none';
    overlay.innerHTML = '';
    overlay.style.background = '';
    document.body.classList.remove('loading-active');
}

const formatDate = (date) => {
    const d = String(date.getDate()).padStart(2, '0');
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
};

window.addEventListener("DOMContentLoaded", () => {
    showLoaderContent();

    const navbarPromise = fetch('/admin/sidebar')
        .then(res => res.text())
        .then(data => {
            const temp = document.createElement('div');
            temp.innerHTML = data;

            // สำคัญ: append navbar, tabs, logoutModal และ notificationDropdown
            const navbar = temp.querySelector('.navbar');
            const tabs = temp.querySelector('.tabs');
            const logoutModal = temp.querySelector('#logoutModal');
            const notificationDropdown = temp.querySelector('#notificationDropdown');

            if (navbar) document.getElementById('navbar').appendChild(navbar);
            if (tabs) document.getElementById('sidebar').appendChild(tabs);
            if (logoutModal) document.body.appendChild(logoutModal);
            if (notificationDropdown) document.body.appendChild(notificationDropdown);

            // Sidebar functions
            window.toggleSidebar = function () {
                document.querySelector(".tabs").classList.toggle("collapsed");
                document.body.classList.toggle("sidebar-collapsed");
            };
            window.showLogoutModal = function () {
                const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
                modal.show();
            };
            window.handleLogout = function () {
                window.location.href = "/login";
            };

            // set active tab
            const currentPath = window.location.pathname;
            document.querySelectorAll('.tab-item').forEach(item => {
                const href = item.getAttribute('href');
                if (href && currentPath.startsWith(href)) item.classList.add('active');
            });

            // ------- Notification Dropdown Logic -------
            setTimeout(() => {
                let allNotifications = [];
                let filterType = "all";
                // Select elements from DOM (after append)
                const notificationBtn = document.getElementById("notificationBtn");
                const notificationDropdown = document.getElementById("notificationDropdown");
                const notificationCount = document.getElementById("notificationCount");
                const notificationList = document.getElementById("notificationList");
                const markAllAsReadBtn = document.getElementById("markAllAsReadBtn");
                const allNotiBtn = document.getElementById("allNotiBtn");
                const unreadNotiBtn = document.getElementById("unreadNotiBtn");

                // Toggle dropdown
                notificationBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle("show");
                    renderNotifications();
                });

                // Close dropdown when clicking outside
                document.addEventListener("click", (e) => {
                    if (!notificationDropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                        notificationDropdown.classList.remove("show");
                    }
                });

                function formatDateDMYHM(dateStr) {
                    const d = new Date(dateStr);
                    const day = String(d.getDate()).padStart(2, '0');
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const year = d.getFullYear();
                    let hour = d.getHours();
                    let min = String(d.getMinutes()).padStart(2, '0');
                    let ampm = "AM";
                    if (hour >= 12) {
                        ampm = "PM";
                        if (hour > 12) hour -= 12;
                    }
                    if (hour === 0) hour = 12;
                    return `${day}/${month}/${year} ${hour}:${min} ${ampm}`;
                }

                function renderNotifications() {
                    notificationList.innerHTML = "";
                    let filtered = [];
                    if (filterType === "unread") {
                        filtered = allNotifications.filter(n => n.is_read === 0);
                    } else {
                        filtered = allNotifications;
                    }

                    if (filtered.length === 0) {
                        notificationList.innerHTML = `<li class="px-3 py-2 text-muted small">No notifications</li>`;
                        return;
                    }

                    filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    filtered.forEach(noti => {
                        const li = document.createElement("li");
                        li.className =
                            "px-3 py-2 small border-bottom cursor-pointer " +
                            (noti.is_read === 0
                                ? "bg-warning-subtle text-dark"
                                : "bg-white text-muted");

                        li.innerHTML = `
                            <div class="fw-bold">${noti.title || ""}</div>
                            <div class="fw-normal">${noti.message || ""}</div>

                            <div class="small text-secondary">${formatDateDMYHM(noti.created_at)}</div>
                        `;

                        li.addEventListener("click", async () => {
                            if (noti.link) window.location.href = noti.link;
                            await fetch("/admin/notifications/read", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ notification_id: noti.notification_id })
                            });
                            noti.is_read = 1;
                            renderNotifications();
                            updateNotificationCount();
                        });

                        notificationList.appendChild(li);
                    });
                }

                async function fetchNotifications() {
                    try {
                        const res = await fetch("/admin/notifications");
                        if (!res.ok) throw new Error("Failed to fetch");
                        const data = await res.json();
                        allNotifications = data;
                        renderNotifications();
                        updateNotificationCount();
                    } catch (err) {
                        console.error(err);
                    }
                }

                function updateNotificationCount() {
                    const unread = allNotifications.filter(n => n.is_read === 0).length;
                    if (unread > 0) {
                        notificationCount.textContent = unread;
                        notificationCount.classList.remove("d-none");
                    } else {
                        notificationCount.classList.add("d-none");
                    }
                }

                markAllAsReadBtn.addEventListener("click", async function () {
                    try {
                        await fetch('/admin/notifications/read-all', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        await fetchNotifications();
                    } catch (e) {
                        console.error(e);
                    }
                });

                allNotiBtn.addEventListener("click", function () {
                    filterType = "all";
                    allNotiBtn.classList.add("active");
                    unreadNotiBtn.classList.remove("active");
                    renderNotifications();
                });

                unreadNotiBtn.addEventListener("click", function () {
                    filterType = "unread";
                    allNotiBtn.classList.remove("active");
                    unreadNotiBtn.classList.add("active");
                    renderNotifications();
                });

                fetchNotifications();
                setInterval(fetchNotifications, 30000);
            }, 300);
        });

    const dormPromise = fetch('/admin/dormitories')
        .then(res => res.json())
        .then(dormData => {
            const dormSelect = document.getElementById('dormSelect');
            dormSelect.innerHTML = '<option value="">All Dormitories</option>';
            dormData.forEach(d => {
                dormSelect.innerHTML += `<option value="${d.dorm_name}">${d.dorm_name}</option>`;
            });
            dormSelect.value = '';
        });

    Promise.all([navbarPromise, dormPromise]).then(() => {
        setTimeout(() => {
            hideLoaderContent();
            reloadDashboardData(document.getElementById('dormSelect').value);
        }, 1000);
    });

    document.getElementById('dormSelect').addEventListener('change', function () {
        reloadDashboardData(this.value);
    });

    async function reloadDashboardData(dorm) {
        try {
            const [summaryData, categoryChartData, roomChartData, recentData] = await Promise.all([
                fetch('/admin/dashboard/summary' + (dorm ? '?dorm=' + encodeURIComponent(dorm) : '')).then(res => res.json()),
                fetch('/admin/dashboard/category-chart' + (dorm ? '?dorm=' + encodeURIComponent(dorm) : '')).then(res => res.json()),
                fetch('/admin/dashboard/room-chart' + (dorm ? '?dorm=' + encodeURIComponent(dorm) : '')).then(res => res.json()),
                fetch('/admin/dashboard/recent' + (dorm ? '?dorm=' + encodeURIComponent(dorm) : '')).then(res => res.json())
            ]);

            document.querySelectorAll('.card h2')[0].textContent = summaryData.total || 0;
            document.querySelectorAll('.card h2')[1].textContent = summaryData.pending || 0;
            document.querySelectorAll('.card h2')[2].textContent = summaryData.confirmed || 0;
            document.querySelectorAll('.card h2')[3].textContent = summaryData.completed || 0;
            document.querySelectorAll('.card h2')[4].textContent = summaryData.cancel || 0;

            const labels = categoryChartData.map(d => d.category_name);
            const values = categoryChartData.map(d => d.count);
            if (barChartInstance) barChartInstance.destroy();
            barChartInstance = new Chart(document.getElementById('barChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Number of Requests',
                        data: values,
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffcd56', '#4bc0c0', '#e57373', '#81c784'],
                        borderRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const roomLabels = roomChartData.map(d => d.room_number);
            const roomValues = roomChartData.map(d => d.count);
            if (roomChartInstance) roomChartInstance.destroy();
            roomChartInstance = new Chart(document.getElementById('roomRepairChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: roomLabels,
                    datasets: [{
                        label: 'Number of Repairs',
                        data: roomValues,
                        backgroundColor: '#9379C2',
                        borderRadius: 10
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true } }
                }
            });

            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = '';
            const sorted = recentData
                .filter(row => row.status === 'Completed')
                .sort((a, b) => new Date(b.request_date) - new Date(a.request_date))
                .slice(0, 10);
            sorted.forEach(row => {
                tbody.innerHTML += `
                    <tr>
                        <td>${formatDate(new Date(row.request_date))}</td>
                        <td>${row.reporter}<br><small>${row.email}</small></td>
                        <td>${row.article}</td>
                        <td>${row.description}</td>
                        <td>${row.room_number}</td>
                        <td>${row.technician || '-'}</td>
                        <td><span class="text-success">${row.status}</span></td>
                    </tr>`;
            });
        } catch (err) {
            console.error("Failed to load admin dashboard data:", err);
        }
        document.getElementById('lastUpdate').textContent = formatDate(new Date());
    }
});
</script>
</body>
</html>